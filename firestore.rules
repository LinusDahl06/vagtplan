rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidWorkspace(workspace) {
      return workspace.name is string &&
             workspace.name.size() > 0 &&
             workspace.name.size() <= 100 &&
             workspace.ownerId is string &&
             workspace.employees is list &&
             workspace.roles is list &&
             workspace.shifts is list;
    }

    // Users collection - profiles
    match /users/{userId} {
      // Anyone can read user profiles (needed for username uniqueness check during signup)
      // Also needed for: workspace owner info, searching users to add as employees
      allow read: if true;

      // Users can create their own profile during signup
      allow create: if isOwner(userId) &&
                      request.resource.data.username is string &&
                      request.resource.data.username.size() >= 3 &&
                      request.resource.data.username.size() <= 30 &&
                      request.resource.data.name is string &&
                      request.resource.data.name.size() > 0 &&
                      request.resource.data.name.size() <= 100 &&
                      request.resource.data.email is string &&
                      request.resource.data.email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');

      // Users can update their own profile
      // Note: subscriptionTier can only be updated (not checked here for simplicity)
      // In production, subscription updates should be handled by backend/payment webhooks
      allow update: if isOwner(userId) &&
                      request.resource.data.username is string &&
                      request.resource.data.username.size() >= 3 &&
                      request.resource.data.username.size() <= 30 &&
                      request.resource.data.name is string &&
                      request.resource.data.name.size() > 0 &&
                      request.resource.data.name.size() <= 100;

      // Users can delete their own profile (for account deletion)
      allow delete: if isOwner(userId);
    }

    // Workspaces collection
    match /workspaces/{workspaceId} {
      // Allow authenticated users to read all workspaces
      // App code will filter to show only relevant workspaces
      // This is necessary because Firebase Rules can't check if userId exists in employees[].userId
      allow read: if isAuthenticated();

      // Only authenticated users can create workspaces
      // NOTE: Subscription limits (max workspaces) are enforced client-side
      // because Firebase Rules cannot count documents owned by a user across the collection
      // In production, use Firebase Functions or backend API for server-side validation
      allow create: if isAuthenticated() &&
                      isValidWorkspace(request.resource.data) &&
                      request.resource.data.ownerId == request.auth.uid;

      // Workspace owner can update workspace
      // Cannot change the ownerId field
      // NOTE: Employee count limits are enforced client-side
      // Firebase Rules cannot access owner's subscription tier from users collection
      // Also allow:
      // - Members to update if they're only removing themselves (for account deletion)
      // - Users to add themselves when accepting an invitation (employee count increases by 1)
      // - All authenticated users (employees check done client-side for shift swaps)
      allow update: if isAuthenticated() &&
                      isValidWorkspace(request.resource.data) &&
                      request.resource.data.ownerId == resource.data.ownerId;

      // Only workspace owner can delete workspace
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // Workspace invitations collection
    match /workspaceInvitations/{invitationId} {
      // Users can read invitations sent to them or that they sent
      // Also allow listing to check for duplicates
      allow read: if isAuthenticated();

      // Workspace owners/managers can create invitations
      allow create: if isAuthenticated() &&
                      request.resource.data.invitedBy == request.auth.uid;

      // Invited user can update to accept/decline
      // Inviter can also delete their own invitation
      allow update: if isAuthenticated() &&
                      resource.data.invitedUserId == request.auth.uid &&
                      resource.data.status == 'pending' &&
                      (request.resource.data.status == 'accepted' ||
                       request.resource.data.status == 'declined');

      // Inviter or invited user can delete invitation
      allow delete: if isAuthenticated() &&
                      (resource.data.invitedBy == request.auth.uid ||
                       resource.data.invitedUserId == request.auth.uid);
    }

    // Shift swap requests collection
    match /shiftSwapRequests/{requestId} {
      // Allow authenticated users to read all swap requests
      // Client-side filtering will show only relevant ones
      allow read, list: if isAuthenticated();

      // Users can create swap requests for their own shifts
      allow create: if isAuthenticated() &&
                      request.resource.data.requesterId == request.auth.uid;

      // Users can update swap requests they created (to cancel)
      // or requests directed at them (to accept/decline)
      allow update: if isAuthenticated() &&
                      (resource.data.requesterId == request.auth.uid ||
                       resource.data.targetEmployeeId == request.auth.uid ||
                       resource.data.isOpenSwap == true);

      // Users can delete their own swap requests
      allow delete: if isAuthenticated() &&
                      resource.data.requesterId == request.auth.uid;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
